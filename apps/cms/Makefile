.PHONY: deploy down logs validate hadolint trivy-fs trivy-image security-scan

COMPOSE ?= docker compose
COMPOSE_FILE ?= docker-compose.prod.yml
IMAGE_NAME ?= ranksheet-cms:latest

deploy:
	$(COMPOSE) -f $(COMPOSE_FILE) up -d --build

down:
	$(COMPOSE) -f $(COMPOSE_FILE) down

logs:
	$(COMPOSE) -f $(COMPOSE_FILE) logs -f --tail=200

validate:
	$(COMPOSE) -f $(COMPOSE_FILE) config

# Security scanning targets
hadolint:
	@echo "ğŸ” Running Hadolint (Dockerfile linter)..."
	@command -v hadolint >/dev/null 2>&1 || { echo "âŒ Error: hadolint not found. Install: brew install hadolint"; exit 1; }
	@hadolint --config .hadolint.yaml Dockerfile

trivy-fs:
	@echo "ğŸ” Running Trivy filesystem scan..."
	@command -v trivy >/dev/null 2>&1 || { echo "âŒ Error: trivy not found. Install: brew install trivy"; exit 1; }
	@trivy fs --config trivy.yaml --scanners vuln,secret,misconfig .

trivy-image:
	@echo "ğŸ” Running Trivy image scan..."
	@command -v trivy >/dev/null 2>&1 || { echo "âŒ Error: trivy not found. Install: brew install trivy"; exit 1; }
	@echo "âš ï¸  Building image first..."
	@$(COMPOSE) -f $(COMPOSE_FILE) build cms
	@echo "ğŸ” Scanning built image..."
	@trivy image --config trivy.yaml ranksheet-cms

security-scan: hadolint trivy-fs
	@echo "âœ… Security scan complete!"
	@echo "ğŸ’¡ To scan the built Docker image, run: make trivy-image"
